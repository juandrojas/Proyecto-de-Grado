%!TEX root = ../main.tex
\chapter{Trace and Residue}\label{ch:trace-and-residue}
We extend the definition of trace to a certain class of infinite dimensional operators to define an abstract residue. We follow the original structure in Tate's elegant article \cite{Tate} while translating his statements in the language of Tate's Linear Algebra.
\section{Finitepotent maps and their trace}
Let $k$ be a fixed ground field and $V$ a vector space over $k$. In this section we will expand the notion of trace of a linear endomorphism to include certain operators even when $V$ is infinite dimensional.
\subsection*{Finitepotent maps}
\begin{definition}\label{def:finitepotent}
	We will say a linear map $f\colon V \to V$ is \textbf{finitepotent} if
	\[
		\dim f^{n}(V) < \infty
	\]
	for sufficiently large $n$.
\end{definition}
We characterize finitepotent maps as follows.
\begin{lemma}\label{lemm:characterization-of-finitepotent-maps}
	A linear map $f\colon V \to V$ is finitepotent if and only if there exists a subspace $W \subseteq V$ such that
	\begin{enumerate}[label = (\roman*)]
		\item $\dim f(W) < \infty$,
		\item $f(W) \subseteq W$,
		\item the induced map $\bar{f}\colon V/W \to V/W$ is nilpotent.
	\end{enumerate}
\end{lemma}
\begin{proof}
	If $f$ is finitepotent choose $W = f^{n}(V)$ for sufficiently large $n$. The first condition follows from definition. Also, $f(W) = f^{n+1}(V) \subseteq f^{n}(V) = W$. In addition, $\bar{f}^{n} = 0$. On the other hand, if such $W$ exists, note that condition (ii) assures that $\bar{f}$ is well defined. Moreover, as $\bar{f}$ is nilpotent, $f^{n}V \subseteq W$ for sufficiently large $n$ and by condition (i) above $\dim f^{n}(V) < \infty$.
\end{proof}
\subsection*{Trace}
If $f$ is a finitepotent map and $W$ is as above, $\tr_{V}(f)\in k$ may be defined as $\tr_{W}(f)$ where $\tr_{W}(f)$ is the ordinary trace of $f$ viewed as a endomorphism of $W$ (which is defined since $f$ has finite-rank viewed in $\End(W)$). First, we will check that this definition does not depend on the choice of $W$. Suppose $W_{1}, W_{2} \subseteq V$ suffice the properties on \cref{lemm:characterization-of-finitepotent-maps}, then $W = W_{1} + W_{2}$ suffices them too. Hence, as the induced maps on $W/W_{1}$ and $W/W_{2}$ are nilpotent, they have have zero ordinary trace and since
\begin{align*}
	\tr_{W}(f) &= \tr_{W_{1}}(f) + \tr_{W/W_{1}}(f) \\
	\tr_{W}(f) &= \tr_{W_{2}}(f) + \tr_{W/W_{2}}(f),
\end{align*}
we obtain $\tr_{W_{1}}(f) = \tr_{W_{2}}(f)$, our desired result. 

This definition extends some of the properties of the ordinary trace.
\begin{lemma}\label{lemm:properties-trace}
	\begin{enumerate}[label = (\alph*)]
		\item If $\dim V < \infty$, any endomorphism $f$ is finitepotent and $\tr_{V}(f)$ coincides with the ordinary trace.
		\item If $f$ is nilpotent, then it is finitepotent and $\tr_{V}(f) = 0$.
		\item If $f$ is finitepotent and $U$ is a subspace such that $f(U) \subseteq U$ then the induced maps on $U$ and $V/U$ are finitepotent and satisfy
		\[
		 	\tr_{V}(f) = \tr_{U}(f) + \tr_{V/U}(f)
		 \] 
	\end{enumerate}
\end{lemma}
\begin{proof}
	Both (a) and (b) are immediate. For (c) if $W$ suffices the properties in \cref{lemm:characterization-of-finitepotent-maps} for $f$ then $W\cap U$ and $(W + U)/U$ suffice them for the induced maps, that is, they're finitepotent. Since $W/(W\cap U) \cong W+U/U$, the diagram
	\[
		\begin{tikzcd}
			W/(W\cap U) \arrow[r, "\cong"] \arrow[d, "f"] & (W+U)/U \arrow[d, "f"] \\
			W/(W\cap U) \arrow[r, "\cong"] & (W+U)/U
		\end{tikzcd}
	\]
	commutes and trace is invariant under conjugation, we get $\tr_{W/(W\cap U)}(f) = \tr_{(W+U)/U}(f)$. Hence
	\[
	 	\tr_{V}(f) = \tr_{W}(f) = \tr_{W\cap U}(f) + \tr_{(W+U)/U}(f) = \tr_{U}(f) + \tr_{V/U}(f)
	\]
\end{proof}
\begin{definition}\label{def:finitepotent subspace}
	A subspace $F$ of $\End_{k}(V)$ is said to be a \textbf{finitepotent subspace} if there exists an $n$ such that for any family of $n$ elements $f_{1}, \ldots, f_{n}\in F$, the space $f_{1}f_{2}\cdots f_{n}V$ is finite dimensional.
\end{definition}
The following is the natural linearity property for $\tr$.
\begin{proposition}\label{prop:linearity-trace}
	If $F$ is a finitepotent subspace then $\tr_{V}\colon F\to k$ is $k$-linear
\end{proposition}
\begin{proof}
	It is enough to prove it in the case that $F$ is finite dimensional. Let $W = F^{n}V$ for $n$ as in the definition of finitepotent subspace, thus $\dim W < \infty$. Hence, for all $f\in F$, $W$ suffices the conditions in \cref{lemm:characterization-of-finitepotent-maps}. It follows that $\tr_{V}(f) = \tr_{W}(f)$ which is linear.
\end{proof}
\begin{remark}\label{rem:general-linearity-trace}
	In his paper, Tate asked if general linearity for finitepotent maps followed. His question was answered negatively in \cite{TATE-TRACE-COUNTER-EXAMPLE} where general linearity is reduced to the following: if the sum of two nilpotent endomorphisms is finitepotent, is the sum necessarily traceless?  
\end{remark}
\begin{proposition}\label{prop:trace-inavriant-under-commutator}
	If $f,g \in \End_{k}(V)$ and $fg$ is finitepotent then $gf$ is also finitepotent and 
	\[
		\tr_{V}(fg) = \tr_{V}(gf).
	\]
\end{proposition}
\begin{proof}
	Since $fg$ is finitepotent let $W =(fg)^{n}V$ for sufficiently large $n$ has finite dimension. On the other hand, $(gf)^{n+1}V= g(fg)^{n}f(V) \subseteq g(W)$, therefore, $gf$ is also finitepotent. Let $W' = (gf)^{n}V$, then $g(W') \subseteq W$ and $f(W) \subseteq W'$. Thus, 
	\[
		\dim W' \leq \dim g(W) \leq \dim W,
	\]
	and, 
	\[
		\dim W \leq \dim f(W) \leq \dim W',
	\]
	which implies that $W\cong W'$ and that $g$ and $f$ induce mutually inverse isomorphisms between $W$ and $W'$. Moreover, the diagram
	\[
		\begin{tikzcd}
			W \arrow[r, "fg"]\arrow[d, "g"] & W \arrow[d, "g"] \\
			W' \arrow[r, "gf"] & W'
		\end{tikzcd}
	\]
	commutes. We conclude $\tr_{W}(fg) = \tr_{W'}(gf)$ and it follows $\tr_{V}(fg) = \tr_{V}(gf)$.
\end{proof}
\section{Differential Calculus}
In this section we introduce the theory of derivations and differentials over an arbitrary commutative ring $A$. Let $M$ be a $A$-module and $k$ a commutative ring. We follow \cite{EGA4} Section 20 and \cite{Matsumura} Section 25. 
\begin{definition}\label{def:derivations-and-differentials}
	A \textbf{derivation} from $A$ to $M$ is a map $D\colon A \to M$ satisfying properties
	\begin{enumerate}[label = (\roman*)]
			\item $D(a + b) = D(a) + D(b)$ and,
			\item (\textit{Leibniz's Rule}) $D(ab) = aD(b) + bD(a)$ 
	\end{enumerate}
for all $a,b \in A$. The set of derivations from $A$ to $M$ becomes a $A$-module in a natural way. We will write it as $\Der(A,M)$. Moreover if $A$ is a $k$-algebra through a map $\varphi\colon k \to A$ we say that $D$ is a $\mathbf{k}$-\textbf{derivation} if $D$ is a derivation and $D \circ \varphi = 0$. In this case, the set of all $k$-derivations is denoted $\Der_{k}(A,M)$.

If $M = A$, we will denote $\Der_{k}(A,A)$ simply by $\Der_{k}(A)$. In particular, if $D$ and $D'$ are two $k$-derivations then its bracket $[D,D'] = DD' - D'D$ under composition as $A \to A$ maps is also a $k$-derivation. Therefore, $\Der_{k}(A)$ under this structure is a Lie Algebra.
\end{definition}
\begin{definition}\label{def:extension-of-algebras}
Let $B$ be a $k$-algebra and $C$ an ideal in $B$ with $C^{2} = 0$; set $A =B/C$. In this way, $C$ can be viewed as a $A$-module. In this situation we say that $B$ is an \textbf{extension} of the $k$-algebra $A$ by the $A$-module $C$. Usually, we simply write the exact sequence
\[\label{eqn:extension}
	0 \to C \to B \xrightarrow{\pi} A \to 0
\]
As usual, we will say that such sequence \textbf{splits} if there exists a retraction; that is, a $k$-algebra homomorphism $\rho\colon A \to B$ such that $\pi \circ \rho = 1_{A}$. In this case we can identify $B = C\oplus A$. Conversely, starting from any $k$-algebra $A$ and any $A$-module $C$, one can always define a structure on $A \oplus C$ such that $A\oplus C$ is an extension of $A$ by $C$. Namely, 
\[
			(a,c)(a',c') = (aa',ac' + a'c)
\]
for $a,a'\in A$ and $c,c' \in C$. Common notations for this algebra are $D_{A}(C)$ or $A * C$.		
\end{definition}
\begin{definition}\label{def:lifting}
Given a commutative diagram of $k$-algebras
\[
	\begin{tikzcd}
		 	B \arrow[r, "f"] & A \\
		 	& C\arrow[lu, "h"] \arrow[u, "g"]
	\end{tikzcd} 
\]
thinking of $f$ as a fixed map. In this situation we say that $h$ is a \textbf{lifting} of $g$ to $B$. 
\end{definition}
\begin{lemma}\label{lemm:two-liftings}
	Suppose we're given a commutative diagram as in the previous definition with an additional lifting $h'\colon C \to B$. Then, if $K = \ker f$ satisfies $K^{2} = 0$ it follows that $h - h'\colon C \to K$ is a $k$-derivation. Conversely, if $D \in \Der_{k}(C, K)$ then $h + D$ is another lifting of $g$ to $B$.
\end{lemma}
\begin{proof}
	First, observe that $(h - h')(C)$ lies in $K$ because both $h$ and $h'$ are liftings of $g$ to $B$. Since $K^{2} = 0$, then $K$ can be considered as $f(B)$-module and by means of $g$ as a $C$-module. Then, $h-h'\colon C \to K$ is a map of $C$-modules. Now, let $c,c' \in C$ then
	\begin{align*}
	(h -h')(cc') &= h(c)h(c') - h'(c)h'(c') \\
	&= h(c)h(c') - h'(c)h'(c') - h(c)h'(c') + h'(c')h(c) \\
	\end{align*}
	since $c \cdot k = h(c)k = h'(c)k$ for all $k \in K$ it follows that
	\begin{align*}
		(h -h')(cc') &= c\cdot h(c') - c'\cdot h'(c') - c\cdot h'(c') + c'\cdot h(c) \\
		&= c\cdot (h - h')(c') + c'\cdot (h - h')(c)
	\end{align*}
	which implies that $h - h'$ is a $k$-derivation. Observe that $h + D$ is a lifting because $D(C)$ lies in $K$.
\end{proof}
\begin{theorem}\label{prop:differentials-representable-functor}
	If $A$ is a $k$-algebra, consider the covariant functor from the category $\mathsf{Mod}_{A}$ to itself given by $M \mapsto \Der_{k}(A,M)$. This functor is representable. 
\end{theorem}
\begin{proof}
	Let $\mu\colon A \otimes_{k} A \to A$ be the $k$-algebra homomorphism given by $f \otimes g \to fg$. Set
	\[
		I = \ker \mu, \quad \Omega_{A/k} = I/I^{2}, \quad \text{and,} \quad B = (A \otimes_{k} A)/I^{2}.
	\]
	Thus, $\mu$ induces $\mu'\colon B \to A$ such that
	\[
		0 \to \Omega_{A/k} \to B \to A \to 0
	\]
	is an extension of $A$ by $\Omega_{A/k}$. We claim that this extension splits. Moreover it has two splittings, by considering retractions
	\[
		j_{1}\colon A \to B \quad\text{and,}\quad j_{2}\colon A \to B,
	\]
	defined by $a \mapsto a\otimes 1$ mod $I^{2}$ and $a \mapsto 1 \otimes a$ mod $I^{2}$. By \cref{lemm:two-liftings} $d := j_{1} - j_{2}$ is a $k$-derivation of $A$ to $\Omega_{A/k}$. Now, we prove that 
	\begin{align}\label{eqn:representable}
		\Der_{k}(A,M) &\cong \Hom_{A}(\Omega_{A/k}, M).
	\end{align}	
	Let $D \in \Der_{k}(A,M)$ and define $\varphi\colon A \otimes_{k} A \to A * M$ by $\varphi(x \otimes y) = (xy, xD(y))$ then $\varphi$ is a $k$-algebra homomorphism since it is compatible with the operation in $A * M$ defined in \cref{def:extension-of-algebras}. In addition, if $\sum x_{i} \otimes y_{i}$ lies in $I$ then
	\[
		\mu\left(\sum x_{i} \otimes y_{i}\right) = \sum x_{i}y_{i} = 0 \implies \varphi\left(\sum x_{i} \otimes y_{i}\right) = (0, \sum x_{i}D(y_{i}))
	\]
	whence $\varphi(I)$ lies in $M$. Moreover, by Leibniz's Rule $\varphi$ factors through $I^{2}$ yielding a map $f\colon \Omega_{A/k}\to M$. For $a \in A$ it follows that 
	\begin{align*}
		f(da) &= f(1 \otimes a - a \otimes 1 \mod I^{2}) = \varphi(1 \otimes a) - \varphi(a \otimes 1) \\
		&= D(a) - aD(1) = D(a). 
	\end{align*} 	
	Therefore, $D = f\circ d$. Now, we prove that such $f$ is unique. First, observe that $\Omega_{A/k}$ has the $A$-module structure induced by multiplication by $a \otimes 1$ (or $1 \otimes a$ since $1 \otimes a - a \otimes 1 \in I$). Therefore, if $\xi = \sum x_{i} \otimes y_{i} \mod I^{2} \in \Omega_{A/k}$ then $a\xi = \sum ax_{i}\otimes y_{i} \mod I^{2}$, and $f(a\xi) = \sum ax_{i}D(y_{i}) = af(\xi)$, so that $f$ is $A$-linear. We have
	\[
		a \otimes a' = (a \otimes 1)(1 \otimes a' - a' \otimes 1) +  aa' \otimes 1
	\]
	so that if $\omega = \sum x_{i}\otimes y_{i} \in I$ then $\omega \mod I^{2} = \sum x_{i} dy_{i}$ since $\sum x_{i}y_{i} = 0$. We conclude that $\{da\mid a\in A\}$ is a set of generators for the $A$-module $\Omega_{A/k}$. This implies uniqueness of $f$. Therefore, (\ref{eqn:representable}) holds.
\end{proof}
\begin{definition}\label{def:module-of-differentials}
	The module $\Omega_{A/k}$ introduced in the proof of the previous theorem is called \textbf{module of differentials} of $A$ over $k$ or \textbf{module of KÃ¤hler differentials}, and for $a \in A$ the element $da\in \Omega_{A/k}$ is called the \textbf{differential} of $a$.
\end{definition}
\textcolor{red}{Further theory to be included if necessary.}

\subsection*{Trace and Tate Spaces}
Suppose that $V$ is a Tate space and consider $E = \End_{k}(V)$ the space of continuous endomorphisms of $V$. Thus, by \cref{prop:compact-and-discrete-2-sided-ideal} and \cref{prop:discrete-compact-operators-present-the-whole-space} we have 2-sided ideals $E_{0}, E_{+}$ and $E_{-}$ of $E$ such that $E_{+} + E_{-} = E$ and $E_{0} = E_{+} \cap E_{-}$. Moreover, \cref{rem:discrete-composition-compact} implies that $E_{0}$ is a finitepotent subspace.





