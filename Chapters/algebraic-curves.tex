%!TEX root = ../main.tex
\chapter{Algebraic curves}\label{ch:algebraic-curves}
In the preceding chapter we presented the ``residue map'' in an abstract context. In this chapter we explore residues on algebraic curves using Tate's construction. 
%\section{Sheaf Theory} 
%We just assume (as in previous chapters) basic homological algebra and algebraic geometry (e.g. the first chapter in \cite{hartshorne}).

%Let $X$ be a topological space.
%\subsection{Presheaves and sheaves}
%\begin{definition}\label{def:presheaf}
%	A \textbf{presheaf} $\mathscr F$ over $X$ is a functor from the opposite category of open sets in $X$ ($U \to V \iff V\subseteq U$ ) to an arbitrary category $\mathcal{C}$ 
%	\[
%		\mathscr F\colon \mathsf{Op}(X)^{\mathtt{op}} \to \mathcal{C}.
%	\]
%	If $U \subseteq V$ then $\mathscr{F}(V) \to \mathscr{F}(U)$. We will call such map $\res^{V}_{U}$ (not to be confused with \textit{residue}) the \textit{restriction} of $V$ to $U$. If $\mathcal{C}$ is $\mathsf{Ab}$ or $\mathsf{Mod}_{A}$ we will simply say a presheaf of abelian groups or $A$-modules respectively.
%\end{definition}
%\begin{definition}\label{def:sheaf}
%	A \textbf{sheaf} $\mathscr F$ on $X$ is a presheaf such that for every open set $U \subseteq X$ and every open cover $\mathscr U = \{U_{\alpha}\}_{\alpha}$ of $U$ the diagram
%	\[
%		\begin{tikzcd}
%			\mathscr{F}(U)\arrow[r] & \prod_{\alpha}\mathscr{F}(U_{\alpha}) \arrow[r, shift right] \arrow[r, shift left] & \prod_{\alpha, \beta} \mathscr{F}(U_{\alpha} \cap U_{\beta})
%		\end{tikzcd}
%	\]
%	is an equalizer. This equalizer can be understood by the following two axioms usually called \textit{sheaf axioms}
%	\begin{enumerate}[label = (\roman*)]
%		\item If $s,t \in \mathscr{F}(U)$ and $\res^{U}_{U_{\alpha}}(s) = \res^{U}_{U_{\alpha}}(t)$ for all $\alpha$ then $s = t$.
%		\item For a collection $\{s_{\alpha}\}_{\alpha}$ such that $\res^{U_{\alpha}}_{U_{\alpha}\cap U_{\beta}}(s_{\alpha}) = \res^{U_{\beta}}_{U_{\alpha}\cap U_{\beta}}(s_{\beta})$ for all $\alpha$ and $\beta$ there exists some $s \in \mathscr{F}(U)$ such that $\res^{U}_{U_{\alpha}}(s) = s_{\alpha}$.
%	\end{enumerate}
%\end{definition}
%\begin{example}\label{ex:examples-of-sheaves}
%	\begin{enumerate}[label = (\alph*)]
%		\item For all $U$ open in $X$ let $C(U)$ denote the ring of continuous functions $U \to \R$. This is a sheaf of rings over $X$. 
%		\item The example we are more interested in is the \textbf{structure sheaf} on a projective variety. That is, for a projective variety $X$ we denote by $\O_{X}(U)$ the ring of regular functions defined on $U$. It is clear that it is a presheaf of rings. The other conditions follow from the fact that a regular function is zero if and only if it is locally zero and it is locally regular if and only if it is locally regular.
%		\item As observed in the previous two examples, sheaves encode local behavior. For instance, let $\mathscr{G}(U)$ denote the ring of continuous constants functions $U \to \R$. In this case $\mathscr{G}$ in a presheaf but not a sheaf (if $X$ has at least two non trivial open sets), this follows from the fact that a locally constant function is not necessarily constant.
%	\end{enumerate}
%\end{example}
%The collection of presheaves of $\mathcal{C}$ over $X$ is a category. Indeed a morphism between two presheaves $\mathscr{F}$ and $\mathscr{G}$ is a natural transformation $\varphi\colon \mathscr{F} \to \mathscr{G}$. That is, for all $U \subseteq V$ open in $X$ the diagram
%\[
%	\begin{tikzcd}
%		\mathscr{F}(V) \arrow[r, "\varphi(V)"] \arrow[d, "\res^{V}_{U}"] & \mathscr{G}(U) \arrow[d, "\res^{V}_{U}"] \\
%		\mathscr{F}(U) \arrow[r, "\varphi(U)"] & \mathscr{G}(U)
%	\end{tikzcd}
%\]
%commutes. We denote $\mathsf{PSh}(X)$. Analogously, the collection of sheaves of $\mathcal{C}$ over $X$ is also a category. We denote it by $\mathsf{Sh}(X)$. 

%\subsection{Sheaf cohomology}

\section{Basic theory of algebraic curves}
In this section we recall briefly and with little detail the basic theory of algebraic projective curves. For a complete exposition we reference the reader to \cite{curves} and \cite{hartshorne}. We will borrow many results from commutative algebra, most of them can be found in \cite{Matsumura}, \cite{comm-alg} and \cite{atiyah}.

Let $k$ be an algebraically closed field. Let $(X, \O_{X})$ be a projective variety. Then 
\[
	k(X) := \varinjlim_{U\subseteq X} \O_{X}(U)
\]
 is the \textbf{function field} or \textbf{field of rational functions} of $X$. In addition, consider the stalk 
\[
	\O_{X,p} := \varinjlim_{p\in U\subseteq X} \O_{X}(U)
\]
of regular functions near $p$. We obtain natural injections 
\[
 	\O_{X}(X) \to \O_{X,p} \to k(X).
\] 
\begin{proposition}\label{prop:fraction-field-local-function-field}
	The fraction field of $\O_{X,p}$ is $k(X)$.
\end{proposition}
\begin{proof}
	Let $U \subseteq X$ be an affine neighborhood of $p$. Suppose that $A$ is the coordinate ring of $X$ on $U$ and let $\mathfrak{p}$ be the maximal ideal of $A$ corresponding to $p$. Therefore, $A_{\mathfrak{p}} = \O_{X,p}$. Since $U$ is affine, $\O_{X}(U) = A$ and $k(U) = \Frac{A}$. Moreover, irreducibility of $X$ implies $k(X) = k(U)$. Hence, 
	\[
		k(X) = k(U) = \Frac{A} = \Frac{A_{\mathfrak{p}}} = \Frac{\O_{X,p}}.
	\]
\end{proof}

In addition, $\O_{X,p}$ is a noetherian local ring of Krull dimension $\dim X$.
Its maximal ideal of regular functions near $p$ that vanish in $p$ is denoted $\mathfrak{m}_{p}$. Observe that evaluation at $p$ yields the isomorphism $\O_{X,p}/\mathfrak{m}_{p} \cong k$.

\subsection{Smoothness and completeness}
\begin{definition}\label{def:regular-local-ring}
	A local ring $(A, \mathfrak{m})$, where $\mathfrak{m}$ denotes its maximal ideal, is called \textbf{regular} if $\dim_{A/\mathfrak{m}} \mathfrak{m}/\mathfrak{m}^{2} = \dim A$. 
\end{definition}
Let $(A,\mathfrak{m})$ be a noetherian regular local ring. Let $k = A/\mathfrak{m}$ be its residue field. In this situation, $(A,\mathfrak{m})$ carries a natural topology, called the $\mathfrak{m}$-adic topology. Namely, $\{\mathfrak{m}^{n}\}_{n\geq 1}$ is a system of neighborhoods around zero and we let the topology to be translation invariant. We already mentioned this topology briefly in \cref{ex:tate-spaces} for the polynomial ring. The $\mathfrak{m}$-adic topology is separated. Indeed, 
\[
	\bigcap_{n\geq 1} \mathfrak{m}^{n} = \{0\}
\]
by Krull intersection theorem. See Theorem (18.29) in \cite{comm-alg}. Just as in \cref{def:completion} we define the \textbf{completion} $\widehat{A}$ of $A$ to be 
\[
	\widehat{A} := \varprojlim_{n\geq 1} A/\mathfrak{m}^{n}.
\]
There is a natural map $A \to \widehat{A}$. In particular, since $A$ is separated, this map is injective. When this map is an isomorphism we say that $A$ is \textbf{complete}. We summarize several properties of completion in the following theorem:
\begin{theorem}\label{thm:properties-adic-completion}
	Let $(A,\mathfrak{m})$ be a noetherian regular local ring. Then
	\begin{enumerate}[label = (\alph*)]
		\item $\widehat{A}$ is a noetherian regular local ring and $\widehat{\mathfrak{m}}$ is its maximal ideal.
		\item Krull dimension is preserved under completion, that is, $\dim A = \dim \widehat{A}$.
		\item (Cohen structure theorem) If $\dim A = n$, then
		\[
			\widehat{A} \cong k\left[[t_{1}, \ldots, t_{n}]\right].
		\]
		Where $t_{1}, \ldots t_{n}$ are mapped to generators of $\mathfrak{m}$.
	\end{enumerate}
	\begin{proof}
	See Chapter 22 in \cite{comm-alg}.  
	\end{proof}
	
\end{theorem}
Now, we explore these results in the geometrical setting. 
\begin{definition}\label{def:}
	If $\O_{X,p}$ is a regular local ring, that is, $\dim_{k} \mathfrak{m}_{p}/\mathfrak{m}_{p}^{2} = \dim \O_{X,p} = \dim X$, we say that $X$ is \textbf{smooth at} $p$. Naturally, $X$ is called \textbf{smooth} if it is smooth at every point $p\in X$.
\end{definition}
We get the following result immediately from \cref{thm:properties-adic-completion}.
\begin{corollary}\label{cor:smooth-iff-isomorphic-to-power-series}
	If $X$ is smooth, then $\widehat{\O_{X,p}} \cong k[[t_{1}, t_{2}, \ldots, t_{n}]]$ where $n = \dim X$.
\end{corollary}
Now, we focus in one-dimensional varieties.
\begin{definition}\label{def:algebraic-curve}
	A \textbf{smooth algebraic curve} is a one-dimensional smooth projective variety.
\end{definition}
In dimension $1$ smoothness can be interpreted in the language of valuations.
\subsection{Valuation theory}
Let $k$ be a field. 
\begin{definition}\label{def:discrete-valuation}
	A \textbf{discrete valuation} is a surjective group homomorphism $\nu\colon k^{\times} \to \Z$ such that, for every $x\in k^{\times}$ and $y \neq -x$ in $k^{\times}$
	\[
		\nu(x + y) \geq \min\{\nu(x), \nu(y)\}.
	\]
	As a convention, we let $\nu(0) = \infty$. We denote by
	\[
	A_{\nu} = \{x \in k\colon \nu(x)\geq 0\}
	\]
	the \textbf{discrete valuation ring} or \textbf{DVR} of $\nu$. Clearly, $A$ is a subring, thus a domain. Consider
	\[
		\mathfrak{m}_{\nu} = \{x\in k\colon \nu(x) > 0\}. 
	\]
	Notice that, if $x\in k$, but $x\notin A_{\nu}$, then $x^{-1}\in \mathfrak{m}_{\nu}$. Hence, $\operatorname{Frac}(A_{\nu}) = K$. Further, observe that
	\[
	A_{\nu}^{\times} = A_{\nu} - \mathfrak{m}_{\nu}.
	\]
	Therefore, $A_{\nu}$ is a local domain with maximal ideal $\mathfrak{m}_{\nu}$. An element $t \in \mathfrak{m}_{\nu}$ with $\nu(t) = 1$ is called a \textbf{uniformizing parameter}. Such $t$ is irreducible because if $t = ab$ with $\nu(a)\geq 0$ and $\nu(b)\geq 0$ implies $\nu(a) = 0$ or $\nu(b) = 0$ since $1 = \nu(a) + \nu(b)$. Further, any $x \in k^{\times}$ has the unique factorization $x = u t^{n}$ where $u \in A_{\nu}^{\times}$ and $n := \nu(x)$. Moreover, $A_{\nu}$ is a principal ideal domain. In fact, any nonzero ideal $\mathfrak{a} \subseteq A_{\nu}$ has the form
	\[
		\mathfrak{a} = \left\langle t^{m}\right\rangle \quad\text{where}\quad m:=\min\{\nu(x)\colon x\in \mathfrak{a}\}.
	\]
	Indeed, given a nonzero $x \in \mathfrak{a}$, say $x = ut^{n}$ where $u \in A_{\nu}^{\times}$. Then $t^{n}\in \mathfrak{a}$. So $n \geq m$. Set $y := ut^{n-m}$. Then $y\in A_\nu$ and $x = yt^{m}$, as desired. Finally, $\mathfrak{m} = \langle t\rangle$ and $\dim A_{\nu} = 1$. Therefore, $A$ is regular local ring of dimension one.
\end{definition}
We have the following characterization theorem for DVRs.
\begin{theorem}\label{thm:characterization-of-DVRs}
	Let $A$ be a noetherian one-dimensional local ring, $\mathfrak{m}$ its maximal ideal and $k = A/\mathfrak{m}$ its residue field. Then these conditions are equivalent:
	\begin{enumerate}[label = (\roman*)]
		\item $A$ is a DVR.
		\item $A$ is integrally closed.
		\item $\mathfrak{m}$ is principal.
		\item $\dim_{k}(\mathfrak{m}/\mathfrak{m}^{2}) = 1$.
		\item Every non-zero ideal is a power of $\mathfrak{m}$.
	\end{enumerate}
\end{theorem}
\begin{proof}
	See Proposition 9.2 in \cite{atiyah}.
\end{proof}
\begin{corollary}\label{cor:smoothness-DVR-curves}
	Let $X$ be a one-dimensional projective variety. Then $X$ is smooth if and only if $\O_{X,p}$ is a DVR for all $p$.
\end{corollary}
\begin{example}\label{ex:stalk-of-regular-functions-as-a-DVR}
	Let $(X,\O_{X})$ be a smooth algebraic curve. Let $p \in X$ and consider $\O_{X,p}$. In this case $\O_{X,p}$ is a DVR. Let $t_{p}\in \O_{X,p}$ be an uniformizing parameter. Hence, if $f \in k(X)$. it follows that $f = ut_{p}^{n}$ for some  unit $u\in \O_{X,p}$ and $n \in \Z$. Then $\nu_{p}(f) = n$.
\end{example}
%\subsection{Morphisms}
%Let $(X,\O_{X})$ and $(Y,\O_{Y})$ be two smooth algebraic curves. 
%\begin{proposition}\label{prop:non-constant-morphism-is-dominant}
%	A non-constant morphism $\varphi\colon X\to Y$ is \textbf{dominant}, i.e, the image of $X$ is dense in $Y$. Therefore, every non-constant morphism from $X$ to $Y$ yields a field extension $k(Y)\subseteq k(X)$.
%\end{proposition}
%\begin{proof}
%	We have that $Z = \overline{\varphi(X)}$ is closed and irreducible in $Y$. Suppose that $Z \neq Y$. We may intersect with affine space such that $Z \cap \A^{n}\neq \emptyset$. It follows that $Z\cap \A^{n}\neq Y\cap \A^{n}$, otherwise their projective closures will coincide. Hence, the prime ideal defined by $Z$ is properly contained in the prime ideal defined by $Y$. Since $\dim Y = 1$, it follows that $\dim Z = 0$, a contradiction.
%\end{proof}

%\begin{proposition}\label{prop:non-constant-morphism-is-surjective}
%	A non-constant morphism $\varphi\colon X\to Y$ is surjective. 
%\end{proposition}

%\begin{proof}
%	The map yields a field extension $k(Y) \subseteq k(X)$. Given a point $p\in Y$ consider the corresponding DVR $A = \O_{Y,p}\subseteq k(Y)$. Let $B_{0}$ be the integral closure of $A$ in $k(X)$. If we localize at a maximal ideal of $B_{0}$ we obtain a DVR $B \subseteq k(X)$. Then $B = \O_{X,q}$ for some $q \in X$. Then $q \mapsto p$. 
%\end{proof}


\subsection{Divisors}
Let $X$ be a smooth algebraic curve. 
\begin{definition}\label{def:divisors}
	A \textbf{divisor} $D$ on $X$ is a finite formal sum of points on $X$, namely
	\[
		D = \sum_{p\in X} n_{p}p, \quad n_{p}\in \Z,\text{ and }n_{p} = 0 \quad\text{for almost all } p.
	\]
	The \textbf{degree} of $D$ is
	\[
		\deg D := \sum_{p\in X}n_{p}.
	\]
	We say that a divisor $D$ is \textbf{effective} and write $D\geq 0$ if $n_{p}\geq 0$ for all $p\in X$. We write $D\geq D'$ if the difference $D - D'$ is an effective divisor. \\
	If $f\in k(X)$ is a non-zero rational function on $X$, the \textbf{principal divisor} $(f)$ is defined by
	\[
		(f):=\sum_{p\in X}\nu_{p}(f)p.
	\]
	In other words, $(f)$ is the sum of the zeroes of $f$ minus the sum of poles of $f$, counting multiplicities. Observe that $(f) + (g) = (fg)$. 

	We say that two divisors $D$ and $D'$ are \textbf{linearly equivalent} if the differ by a principal divisor, that is, there exists some rational function $f$ such that $D + (f) = D'$.

	Given a divisor $D = \sum_{p}n_{p}p$ we define the $k$-vector space
	\[
		L(D) := \{f\in k(X)\colon f = 0\text{ or } \nu_{p}(f) \geq -n_{p}\}.
	\]
	For instance, if $D$ is effective $L(D)$ consists of rational functions having a pole at $p\in X$ of order at worst $n_{p}$ for each $p\in X$. We write $\ell(D) := \dim_{k}(L(D))$.
\end{definition}
%\begin{proposition}\label{prop:degree-of-principal-divisor}
	%For all $f\in k(X)^{\times}$ the principal divisor of $f$ has zero degree.
%\end{proposition}
%\begin{proof}
	
%\end{proof}

\section{Tate spaces over algebraic curves}
Let $(X,\O_{X})$ be a smooth algebraic curve over an algebraically closed field $k$.
\subsection{Residue in coordinates}
Let $K := k(X)$. For all $p \in X$ we use the following notation $L_{p} := \widehat{\O_{X,p}}$ and $K_{p}:=\Frac L_{p}$. From \cref{thm:properties-adic-completion} and $\cref{thm:characterization-of-DVRs}$, it follows that $L_{p}$ is a DVR. Let $t_{p}$ be an uniformizing parameter in $L_{p}$. The topology in $K_{p}$ is defined by letting $\{t_{p}^{n}L_{p}\}_{n\in \Z}$ be a system of neighborhoods of zero in $K_{p}$. This system is compatible with the valuation induced by $L_{p}$.
\begin{proposition}\label{prop:complete-fraction-field-is-a-Tate-space}
	$K_{p}$ is a Tate space and $L_{p}$ is a c-lattice in $K_{p}$.
\end{proposition}
\begin{proof}
	Observe that the map $\mathfrak{m}_{p}^{n}\O_{X,p}/\mathfrak{m}_{p}^{n+1}\O_{X,p} \to \O_{X,p}/\mathfrak{m}_{p}\O_{X,p}$ induced by inclusions is an isomorphism. Then the exactness of
	\[
		0 \to \mathfrak{m}_{p}^{n}\O_{X,p}/\mathfrak{m}_{p}^{n+1}\O_{X,p} \to \O_{X,p}/\mathfrak{m}_{p}^{n+1}\O_{X,p} \to \O_{X,p}/\mathfrak{m}_{p}^{n}\O_{X,p} \to 0
	\]
	implies that every quotient $\O_{X,p}/\mathfrak{m}_{p}^{n}\O_{X,p}$ is finite-dimensional over $k$. Therefore, 
	\[
		L_{p} = \varprojlim_{n\geq 1} \O_{X,p}/\mathfrak{m}_{p}^{n}\O_{X,p}
	\]
	is an inverse limit of finite-dimensional $k$-vector spaces. Hence, $L_{p}$ is complete and linearly compact by \cref{ex:tate-spaces}. Since $L_{p}$ is open in $K_{p}$, it is a c-lattice and $K_{p}$ is a Tate space.
\end{proof}
\begin{remark}\label{rem:mutually-commensurable-system}
\begin{enumerate}[label = (\alph*)]
	\item Observe that $\{t_{p}^{n}L_{p}\}_{n\in \Z}$ is a mutually commensurable system of neighborhoods around zero of consisting of $k$-vector subspaces of $K_{p}$. 
	\item Let $f\in K_{p}$, observe that $fL_{p} = t_{p}^{n}L_{p}$ for some $n \in \Z$ and uniformizing parameter $t_{p} \in L_{p}$. It follows that multiplication by $f$ in $K_{p}$ is continuous in $K_{p}$, that is, $K_{p}$ (and particularly $K$) acts continuously over itself.
\end{enumerate}
\end{remark}
\begin{definition}\label{def:residue-at-p}
	Let $f,g \in K_{p}$. We define the residue of the differential $fdg$ at $p\in X$ to be
	\[
		\res_{p}(fdg) = \res_{K_{p}}(fdg).
	\]
	where $\res_{K_{p}}$ denotes the abstract residue defined in \cref{thm:existence-of-residue}.
\end{definition} 
\begin{proposition}\label{prop:no-poles-zero-residue}
	Let $p\in X$. If $\omega \in \Omega_{K_{p}/k}$ has no poles at $p$ then $\res_{p}(\omega) = 0$.
\end{proposition}
\begin{proof}
	Clear from \cref{prop:residue-and-continuity}.
\end{proof}

\begin{theorem}\label{thm:resiude-coincides-with-coefficient}
	Let $f,g \in K_{p}$. By the structure theorem in \cref{thm:properties-adic-completion}, it follows that $f = \sum_{\nu \gg -\infty}^{\infty} a_{\nu}t_{p}^{\nu}$ and $g = \sum_{\mu \gg -\infty}^{\infty} b_{\mu}t_{p}^{\mu}$ for some $a_{\nu},b_{\mu} \in k$ and a uniformizing parameter $t_{p}\in L_{p} $. Recall that the formal derivative of $g$ is
	\[
		g' = \sum_{\mu \gg -\infty}^{\infty} \mu b_{\mu}t_{p}^{\mu -1}.
	\]
	Then
	\[
		\res_{p}(fdg) = \text{coefficient of }t_{p}^{-1}\text{ in } fg',
	\]
	which is given by the Cauchy product
	\[
		\res_{p}(fdg) = \sum_{\mu + \nu = 0}\mu a_\nu{}b_{\mu}.
	\]
\end{theorem}
\begin{proof}
	Let
	\[
		\tilde{f} = \sum_{\nu\gg-\infty}^{N} a_{\nu}t_{p}^{\nu},\quad\text{and}\quad\tilde{g} = \sum_{\mu\gg-\infty}^{N} b_{\mu}t_{p}^{\mu}.
	\]
	Then
	\begin{align*}
		\res_{p}(fdg) &= \res_{p}( (\tilde{f} + (f - \tilde{f}))d(\tilde{g} + (g - \tilde{g}))) \\
		&= \res_{p}(\tilde{f}d\tilde{g}) + \res_{p}(\tilde{f}d(g - \tilde{g})) + \res_{p}((f-\tilde{f}) d\tilde{g}) \\ &+ \res_{p}( (f - \tilde{f})d(g-\tilde{g})).
	\end{align*}
	If $N$ is sufficiently large, then by \cref{prop:residue-and-continuity}, it follows that 
	\[
		\res_{p}( (f - \tilde{f})d(g-\tilde{g})) = \res_{p}(\tilde{f}d(g - \tilde{g})) = \res_{p}((f-\tilde{f}) d\tilde{g}) = 0.
	\]
	Therefore, we can assume that only finitely many of the $a_{\nu}$ and $b_{\mu}$ are non-zero. Now, $fdg = f g' dt$ and by \cref{prop:residue-of-a-power} only the term of $t_{p}^{-1}$ can have non-zero residue. Then, by \cref{prop:residue-of-invertible-element}, it follows that
	\[
		\res_{p}(t_{p}^{-1}dt_{p}) = \dim_{k}(L_{p}/t_{p}L_{p}) = \dim_{k}k = 1. 	
	\]
	Hence, $k$-linearity of residue implies the desired conclusion.
\end{proof}
\begin{corollary}\label{cor:invriance-of-residue-coefficient}
	Let $f\in K_{p}$. Then the coefficient of $t_{p}^{-1}$ in the Laurent series expansion of $f$ is independent of the choice of uniformizing parameter $t_{p}$.	
\end{corollary}
\begin{remark}\label{rem:previouses-approaches-residues}
	Before Tate introduced this approach to residues of differentials on algebraic curves, residues were defined by the formula in \cref{thm:resiude-coincides-with-coefficient}. However, to prove that such formula is well-defined, it is necessary to argue that the coefficient of $t_{p}^{-1}$ is independent of the choice of uniformizing parameter $t_{p}$. If $\operatorname{char}k = 0$, one can realize $X$ as an analytical variety and reduce independence to the invariance of the formula
	\[
		\res_{p}(\omega) = \frac{1}{2\pi i}\oint_{p} \omega.
	\]
	Nevertheless, in the general setting it is not obvious why invariance follows. In \cref{cor:invriance-of-residue-coefficient} we gave a clean but theory-demanding proof of such result. We reference the reader to \cite{serre} Chapter 2 Section 10 for a direct proof.
\end{remark}
\subsection{Adèles and the residue theorem}
Our next goal is to prove the residue theorem. In order to prove it, we will take an \textit{adèlic} approach, borrowing many techniques from number theory.
\begin{definition}\label{def:adele-ring-over-algebraic-curve}
	Let $X$ be a smooth algebraic curve. Let $Y \subseteq X$ be any subset. Let $\mathscr{F}$ denote the set of all finite subsets of $Y$. Let $S \in \mathscr{F}$, the $\mathbf{S}$-\textbf{adèle} of $K$ indexed by $Y$ is defined as the product
	\[
		\widetilde{K}_{Y,S} := \prod_{p\in Y\setminus S}L_{p} \times \prod_{p\in S}K_{p}
	\]
	in its product topology. The \textbf{adéle} $\widetilde{K}_{Y}$ of $K$ indexed by $Y$ is the direct limit of the system indexed by $\mathscr{F}$, namely, if $S \subseteq T$ there exists a injection $\iota_{ST}\colon \widetilde{K}_{Y,S} \hookrightarrow \widetilde{K}_{Y,T}$ given by the inclusion. Endow
	\[
		\widetilde{K}_{Y} = \varinjlim_{S \in \mathscr{F}} \widetilde{K}_{Y,S}
	\]
	with its direct limit topology. Usually, for $X = Y$ we will simply write $\widetilde{K}$ for $\widetilde{K}_{X}$.
\end{definition}
The adèle of $K$ is a particular case of a \textbf{restricted product} of a collection of topological spaces. In the literature, this construction defined as a \textit{set} in terms of the product. We give this characterization in the following proposition.
\begin{proposition}\label{prop:adèle-as-subset-of-product}
	\[
		\widetilde{K}_{Y} = \{(f_{p})\colon f_{p} \in K_{p}\text{ for all }p \in Y\text{ and }f_{p}\in L_{p}\text{ for almost all }p\in Y\}
	\]
	where \textit{almost all} means for all but finitely many $p\in Y$, equipped with the following collection as a basis for its topology
	\[
		\left\{\prod_{p\in Y} U_{p} \colon U_{p}\text{ is open for all }p\in Y\text{ and }U_{p} = L_{p}\text{ for almost all }p\in Y\right\}.
	\]
\end{proposition}
\begin{proof}
	Let $K^{\sharp}$ be the topological space defined in the statement of the proposition. Observe that $K^{\sharp}$ is linearly topologized as a $k$-vector space. We will prove that $K^{\sharp}$ satisfies the universal property of $\widetilde{K}_{Y}$ in the category $\mathsf{LinTop}_{k}$. First, observe that the inclusion
	\[
		\widetilde{K}_{Y,S} \hookrightarrow K^{\sharp}
	\]
	is a continuous homomorphism and the diagram
	\[
		\begin{tikzcd}
			& K^{\sharp} & \\
			\widetilde{K}_{Y,S} \arrow[rr, "\iota_{ST}", hook]\arrow[ur, hook] & & \widetilde{K}_{Y,T} \arrow[lu, hook]
		\end{tikzcd}
	\]
	commutes. Moreover, for every $P$ equipped with continuous homomorphisms $\varphi_{S}\colon \widetilde{K}_{Y,S}\to P$ such that the diagram 
	\[
		\begin{tikzcd}
			& P & \\
			\widetilde{K}_{Y,S} \arrow[rr, "\iota_{ST}", hook]\arrow[ur, hook, "\varphi_{S}"] & & \widetilde{K}_{Y,T} \arrow[lu, hook, "\varphi_{T}", swap]
		\end{tikzcd}
	\]
	commutes. Then define $\varphi\colon K^{\sharp} \to P$ as follows: for $(f_{p}) \in K^{\sharp}$ there exists a $S\in \mathscr{F}$ such that $f_{p} \in L_{p}$ if and only if $p \in S$. Define $\varphi( (f_{p})_{p\in Y} ) = \varphi_{S}( (f_{p})_{p\in Y} )$. This is a continuous homomorphism and it is the only one such that the diagram
	\[
		\begin{tikzcd}
			& P & \\
			& K^{\sharp} \arrow[u, "\varphi", dotted] & \\
			\widetilde{K}_{X,S} \arrow[rr, "\iota_{ST}"]\arrow[uur, "\varphi_{S}"]\arrow[ur, hook] & & \widetilde{K}_{X,T} \arrow[luu, "\varphi_{T}", swap] \arrow[lu, hook]
		\end{tikzcd}
	\]
	commutes. This implies $K^{\sharp} = \widetilde{K}_{Y}$ (or canonically isomorphic).
\end{proof}
\begin{remark}\label{rem:adèle-not-subspace-topology}
	Observe that the topology in $\widetilde{K}_{Y}$ is finer than the one it inherits as a subspace of the product $\prod_{p\in Y}K_{p}$. For instance, observe that 
	\[
		\widetilde{L}_{Y} := \prod_{p\in Y}L_{p} 
	\] 
	is open in $\widetilde{K}$, but it is open in $\prod_{p\in Y} K_{p}$ if and only if $Y$ is finite. 
\end{remark}
If $D = \sum_{p}n_{p}p$ is a divisor, let
\[
	\widetilde{K}(D) = \{(f_{p})_{p}\in \widetilde{K}\colon \nu_{p}(f_{p}) \geq -n_{p}\}
\]
a $k$-vector subspace of $\widetilde{K}$. By the description we gave in \cref{prop:adèle-as-subset-of-product} $\widetilde{K}(D)$ is open for all divisors $D$ and they form a system of neighborhoods around zero of mutually commensurable vector subspaces in $\widetilde{K}$. In this notation, $\widetilde{K}(0) = \widetilde{L}$.
\begin{proposition}\label{prop:adèle-is-a-tate-space}
	$\widetilde{K}_{Y}$ is a Tate space and $\widetilde{L}_{Y}$ is a c-lattice in $\widetilde{K}_{Y}$. 
\end{proposition}
\begin{proof}
	First, observe that
	\[
		\prod_{p\in Y} L_{p} = \varprojlim_{p\in Y} L_{p} = \varprojlim_{p\in Y}\varprojlim_{n\geq 1} \O_{Y,p}/\mathfrak{m}_{p}^{n}\O_{Y,p} = \varprojlim_{(p,n)\in Y\times \N^{\geq 0}} \O_{Y,p}/\mathfrak{m}_{p}^{n}\O_{Y,p}
	\] 
	for $Y$ realized as trivial category. Hence, $\widetilde{L}_{Y}$ is the inverse limit of a projective system of finite dimensional $k$-vector spaces. Therefore, $\widetilde{L}_{Y}$ is a complete linearly compact vector space over $k$. Since $\widetilde{L}_{Y}$ is open in $\widetilde{K}_{Y}$, it is a c-lattice in $\widetilde{K}_{Y}$ and $\widetilde{K}_{Y}$ is a Tate space.
\end{proof}

\begin{proposition}\label{prop:K-discrete-in-adèle}
	$K$ is realized as a discrete vector subspace of $\widetilde{K}$ by means of the diagonal embedding $f \mapsto (f)_{p\in X}$. 
\end{proposition}
\begin{proof}
	Observe that 
	\[
		K\cap \widetilde{L} = \bigcap_{p\in X}\O_{X,p} = \O_{X}(X).
	\]
	Indeed, the first equality is obvious and the second follows from the fact that a regular function is globally defined on $X$ if and only if it is regular at every point $p$. Since $X$ is projective and geometrically irreducible, $\O_{X}(X) \cong k$ (see, e.g \cite{hartshorne} Chapter 1 Theorem 3.4). Therefore, $K\cap \widetilde{L}$ is a finite-dimensional $k$-vector space, thus discrete. Since $\widetilde{L}$ is open, it follows that $K$ is discrete. 
\end{proof}
Our next objective is to show that $\widetilde{K}/K$ is linearly compact. To prove this, for a divisor $D = \sum_{p\in X}n_{p}p$ we study the quotient
\[
	I(D) := \widetilde{K}/(\widetilde{K}(D) + K).
\]
Many techniques here are taken from \cite{fulton}. By construction we have the following exact sequence
\[
	0 \to L(D) \to K \to \widetilde{K}/\widetilde{K}(D) \to I(D) \to 0.
\]
An element $(\overline{f}_{p})_{p}\in \widetilde{K}/\widetilde{K}(D)$ can be described as follows: at each point $p \in X$, $\overline{f}_{p}$ is given by a \textbf{Laurent tail}
\[
	\overline{f}_{p} = a_{\nu}t_{p}^{\nu} + a_{\nu + 1}t_{p}^{\nu+1} + \ldots + a_{-n_{p}-1}t_{p}^{-n_{p}-1}
\]
where $t_{p}$ is a uniformizing parameter at $p$, $\nu\in \Z$, $\nu\leq n_{p}$, and $a_{i}\in k$. Moreover, only finitely many $\overline{f}_{p}$ are non-zero.
\begin{example}\label{ex:I(D)-for-P^1}
	Let $X = \P^{1}$. We claim $I(0) = 0$. Indeed, an element $\overline { f } \in \widetilde{K} / \widetilde{K} ( 0 )$ is a finite collection of Laurent tails as above, where $n _ { p } = 0$ for all $p .$ Choose an affine coordinate $x = X _ { 1 } / X _ { 0 }$ on $\mathbb { P } ^ { 1 }$ such that the points $p _ { 1 } , \ldots , p _ { k }$ such that $\overline { f } _ { p } \neq 0$ lie in the affine piece $\A _ { x } ^ { 1 } = \left( X _ { 0 } \neq 0 \right) \subset \mathbb { P } ^ { 1 } ,$ with $x$ coordinates $\alpha _ { 1 } , \ldots , \alpha _ { k } .$ Then $x - \alpha _ { i }$ is a local parameter at $p _ { i } ,$ and we can write 
	\[
		\overline { f } _ { p_ { i } } = g _ { i } = a _ { \nu _ { i } , i } \left( x - \alpha _ { i } \right) ^ { \nu _ { i } } + \cdots + a _ { - 1 , i } ( x - \alpha_{1} ) ^ { - 1 }
	\]
	Define $g = \sum g _ { i } \in k ( X ) ,$ then $g$ has Laurent tail $\overline { f } _ { p _ { i } }$ at $p _ { i }$ and is regular elsewhere, that is, $g \mapsto \overline { f } \in \widetilde{K}/ \widetilde{K} ( 0 ) .$ Hence $I ( 0 ) = 0$ as claimed.
\end{example}
\begin{lemma}\label{lemm:inequality-divisors-yields-surjection}
	Suppose $D\leq D'$. Then, there is a natural surjection $I(D) \to I(D')$, and the kernel has dimension
	\[
		(\deg D' - \ell(D')) - (\deg D - \ell(D)).
	\]
\end{lemma}
\begin{proof}
	By definition $\widetilde{K}(D) \subseteq \widetilde{K}(D')$, so $I(D)$ surjects onto $I(D')$. Consider the commutative diagram 
	\[
	\begin{tikzcd}
		0  \ar[r] &  K/L(D) \ar[d] \ar[r] & \widetilde{K}/\widetilde{K}(D) \ar[d] \ar[r] & I(D) \ar[d] \ar[r] & 0 \\
		0 \ar[r] &  K/L(D')  \ar[r] & \widetilde{K}/\widetilde{K}(D')  \ar[r] & I(D')  \ar[r] & 0
	\end{tikzcd}
	\]
	The vertical arrows are surjective, so the kernels form an exact sequence
	\[
	0 \to L(D')/L(D) \to \widetilde{K}(D')/\widetilde{K}(D) \to M \to 0
	\]
	where $M = \ker(I(D) \to I(D'))$. Finally, observe that $\widetilde{K}(D')/\widetilde{K}(D)$ has dimension $\deg D' - \deg D$. Indeed, writing $D = \sum_{p}n_{p}p$ and $D' = \sum_{p}n_{p}'p$, an element $(\overline{f}_{p})_{p} \in \widetilde{K}(D')/\widetilde{K}(D)$ is given by Laurent tails 
	\[
	 \overline{f}_{p} =  a _ { - n _ { p } ^ { \prime } } t_{p} ^ { - n _ { p } ^ { \prime } } + a _ { - n _ { p } ^ { \prime } + 1 } t_{p} ^ { - n _ { p } ^ { \prime } + 1 } + \cdots + a _ { - n _ { p } - 1 } t_{p} ^ { - n _ { p } - 1 }
	\]
	where $t_{p}$ denotes a uniformizing parameter at $p$. So, 
	\[
		\dim_{k} \widetilde{K}(D')/\widetilde{K}(D) = \sum_{p}(n_{p}' - n_{p}) = \deg D' - \deg D
	\]
	as claimed. This yields the formula for $\dim_{k}M$.
\end{proof}
\begin{lemma}[Riemann's theorem]\label{lemm:bound-on-L(D)}
	There exists $N \in \N$ such that $\deg D - \ell(D)\leq N$ for all divisors $D$ on $X$.
\end{lemma}
\begin{proof}
	Let $f \in K$ be a non-constant rational function and 
	\[
		F = (1 : f)\colon X \to \P^{1}
	\]
	the associated morphism. Let $A = F^{*}(0 : 1)$, so $A$ is the divisor of degree $d$ given by the sum of the poles of $f$ with multiplicities. Let $D$ be a divisor on $X$. We claim that there exists a linearly equivalent divisor $D'$ such that $D' \leq nA$ for some $n \in \N$. Indeed, write $D = \sum_{p}n_{p}p$, and define 
	\[
		h = \prod_{p\in S}(f - f(p))^{n_{p}}
	\]
	where
	\[
		S = \{p \in X\colon n_{p} > 0, f(p)\neq \infty\}.
	\]
	Then $(h) \geq D - nA$ for some $n \in \N$, that is, $D' := D - (h) \leq nA$, as desired. 

	We now establish the result for divisors $D = nA$ for $n\in \N$. The morphism $F$ corresponds to the field extension $k(f) \subseteq k(X)$ of degree $d$. Pick a basis $g_{1}, \ldots, g_{d}$ for $k(X)$ over $k(f)$. Then, by the construction in the previous paragraph, there exist polynomials $q_{i}(t) \in k[t]$ such that $q_{i}(f)g_{i} \in L(n_{0}A)$ for all $1 \leq i \leq d$ and some $n_{0}\in \N$. Indeed, let $D = -(g_{i})$ and define $q_{i}(f) = h$ as above. Then $(hg_{i}) = -D' \leq n_{i}A$ for some $n_{i}\in \N$. Let $n_{0} = \max{n_{i}}$. Then $f^{j}q_{i}(f)g_{i} \in L(nA)$ for each $1 \leq i \leq d$ and $0 \leq j \leq n - n_{0}$. Moreover, these functions are linearly independent over $k(f)$ because $g_{1},\ldots,g_{d}$ are linearly independent over $k(f)$. So,
	\[
		\ell(nA) \geq (n - n_{0} + 1)d = \deg nA - (n_{0} - 1)d,
	\]
	that is, $\deg nA - \ell(nA) \leq N$ where $N:= (n_{0} -1)d$. 

	Combining our results, if $D$ and $D'$ are linearly equivalent and $D' \leq nA$ then 
	\[
		\deg D - \ell(D) = \deg D' - \ell(D') \leq \deg nA - \ell(nA) \leq N. 		
	\]
\end{proof}
\begin{theorem}\label{thm:I(D)-is-finite-dimensional}
	For all divisors $D$ on $X$ we have $\dim_{k}I(D) < \infty$.
\end{theorem}
\begin{proof}
	By \cref{lemm:bound-on-L(D)}, there exists a divisor $D_{0}$ on $X$ such that $\deg D_{0} - \ell(D_{0})$ is maximal. We claim that $I(D_{0}) = 0$. Indeed, otherwise let $(\overline{f}_{p})_{p}\in I(D)$ nonzero. Pick $D' \geq D_{0}$  $D '= \sum_{p}n_{p}' p$ such that $\nu_{p}(f_{p}) \geq -n_{p}'$ for all $p\in X$, then $(f_{p})_{p}$ lies in the kernel of the surjection $I(D_{0})\to I(D')$. So $\deg D' - \ell(D') > \deg(D_{0}) - \ell(D_{0})$ by \cref{lemm:inequality-divisors-yields-surjection}, a contradiction. 

	If $D\leq D'$ we have a surjection $I(D) \to I(D')$ with finite-dimensional kernel by \cref{lemm:inequality-divisors-yields-surjection}. Thus $I(D) \sim I(D')$. Since $I(D_{0})$ is finite dimensional, we deduce that $I(D)$ is finite dimensional for every divisor $D$.
\end{proof}
\begin{corollary}\label{cor:adele-mod-K-is-linearly-compact}
	$\widetilde{K}/K$ is linearly compact.
\end{corollary}
\begin{proof}
	For every divisor $D$ on $X$ the exact sequence
	\[
	0 \to (\widetilde{K}(D) + K)/ K \to \widetilde{K}/K \to I(D) \to 0,
	\]
	the fact that the collection $\widetilde{K}(D)$ is a system of neighborhoods around zero of vector subspaces in $\widetilde{K}$ and \cref{thm:I(D)-is-finite-dimensional} yield the result.
\end{proof}
\begin{corollary}\label{cor:residue-adéle-trivial}
	For all $p\in X$
	\[
		\res_{\widetilde{K}}(\Omega_{K/k}) = 0.
	\]
\end{corollary}
\begin{proof}
	The statement follows from \cref{prop:linearity-residue-closed-submodule}, \cref{prop:residue-trivial-tate-space}, \cref{prop:K-discrete-in-adèle} and \cref{cor:adele-mod-K-is-linearly-compact}.
\end{proof}

Now, we are ready to prove the residue theorem. 
\begin{theorem}[Residue Theorem]\label{thm:residue-theorem}
	For $X$ a smooth algebraic curve and $\omega \in \Omega_{K/k}$, the identity 
	\[
		\sum_{p\in X}\res_{p}(\omega) = 0
	\]
	holds. 
\end{theorem}
\begin{proof}
	First, observe that the expression $\sum_{p\in X}\res_{p}(\omega) = 0$ makes sense by \cref{prop:no-poles-zero-residue} and the fact that $\omega$ has a finite amount of poles. Now, it is enough to prove the statement for $\omega = fdg$ for $f,g \in K$. Let $p_{1}, \ldots, p_{n}$ be the collection of poles of $f$ and $g$ combined. Then, the product $K_{p_{1}} \oplus K_{p_{2}} \oplus \cdots K_{p_{n}}$ is a closed $K$-submodule of $\widetilde{K}$ (it is the kernel of the projection on the coordinates different than $p_{i}$). Choose $M$ a complementary subspace. Then
	\[
		\widetilde{K} = K_{p_{1}} \oplus K_{p_{2}} \oplus \cdots K_{p_{n}} \oplus M. 
	\] 
	Let $U = \widetilde{L} \cap M$. Then $U$ is a c-lattice in $M$ and $fU \subseteq U$ and $gU \subseteq U$. Hence, \cref{prop:residue-and-continuity} yields
	\[
		\res_{M}(\omega) = 0.
	\]
	Therefore, by \cref{prop:direct-sum-residue} and \cref{cor:residue-adéle-trivial} it follows that
	\[
		0 = \res_{\widetilde{K}}(\omega) = \sum_{p\in X}\res_{p}(\omega).
	\]
\end{proof}
\section{Riemann-Roch formula}
We finish up this chapter by proving the Riemann-Roch formula by means of adèlic methods. 

\subsection{Differential pairing and the adèlic complex}
Let $X$ be a smooth algebraic curve, $K$ its function field and $\widetilde{K}$ it associated adèle ring. In the previous section we introduced the \textbf{adèlic complex} of $X$, that is, for every divisor $D$ one has the complex $\mathcal{A}(D)$ 
\[
	K\oplus \widetilde{K}(D) \to \widetilde{K}, \quad (\alpha,\beta) \mapsto \alpha - \beta.
\]
This complex is quasi-isomorphic to the complexes
\[
	\widetilde{K}(D) \to \widetilde{K}/K, \quad K\to \widetilde{K}/\widetilde{K}(D)
\]
and we have $H^{0}(\mathcal{A}(D)) = K \cap \widetilde{K}(D)$ and $H^{1}(\mathcal{A}(D)) = \widetilde{K}/(\widetilde{K}(D) + K)$. Since $\widetilde{K}(D)$ is linearly compact and $K$ is discrete it follows that $\dim_{k}H^{0}(\mathcal{A}(D)) < \infty$. Moreover, we proved in \cref{thm:I(D)-is-finite-dimensional} that $H^{1}(\mathcal{A}(D))$ is finite-dimensional. To study these cohomology groups we will introduce the notion of canonical divisor and the differential pairing.
\vspace{5mm}

First, we will extend the valuation $\nu_{p}$ for all $p\in X$ for differentials $\omega\in \Omega_{K/k}$. Let $t_{p}$ be a uniformizing parameter at $p$. Then, write $\omega = f dt_{p}$ for $f\in K$ and set $\nu_{p}(\omega) = \nu_{p}(f)$. This formula does not depend on the choice of uniformizing parameter $t_{p}$.
\begin{definition}\label{def:canonical-divisor}
	Let $\omega\in \Omega_{K/k}$. We define the \textbf{canonical divisor} $W$ of $\omega$ to be the principal divisor associated to $\omega$. 
\end{definition}
\begin{remark}\label{rem:canonical-divisor-are-all-linearly-equivalent}
	The fact (see the proof of \cref{prop:differentials-representable-functor}) that $\dim_{K}\Omega_{K/k} = 1$ implies that all canonical divisors are linearly equivalent.
\end{remark}
\begin{definition}\label{def:differential-pairing}
	For a differential $\omega\in \Omega_{K/k}$ we define the differential pairing $\langle -, -\rangle$ on $\widetilde{K} \times \widetilde{K}$ by the formula
	\[{}
		\langle (f_{p})_{p}, (g_{p})_{p}\rangle =  ((f_{p})_{p}, (g_{p})_{p})\mapsto \sum_{p\in X}	\res_{p}(f_{p}g_{p}\omega).
	\]
	Observe that $\langle -,-\rangle$ is continuous. Indeed, multiplication and the assignment $(f_{p})_{p} \mapsto \res_{p}(f_{p}\omega)$ are continuous in $\widetilde{K}(X)$.
\end{definition}
For a $k$-vector subspace $V \subseteq \widetilde{K}$ let $V^{\perp} = \{(f_{p})_{p} \in \widetilde{K}\colon \langle V, (f_{p})_{p}\rangle = 0\}$.
\begin{lemma}\label{lemm:complement-of-K}
	$K \subseteq K^{\perp}$ and $K^{\perp}$ is a $K$-vector space. 
\end{lemma}
\begin{proof}
	The Residue Theorem (\cref{thm:residue-theorem}) implies that $K \subseteq K^{\perp}$. The fact that $K^{\perp}$ is a $K$-space is obvious.
\end{proof}
In fact, one can prove a stronger statement.
\begin{lemma}\label{lemm:K-equals-its-complement}
	$K = K^{\perp}$.
\end{lemma}
\begin{proof}
	Consider the quotient $K^{\perp}/K$. It is a closed subspace of $\widetilde{K}/K$ because the pairing $\langle -,-\rangle$ is continuous. Hence, it is linearly compact. Moreover, the pairing map yields an injection $K^{\perp} \hookrightarrow (\widetilde{K}/K)^{*}$. Since $(\widetilde{K}/K)^{*}$ is a discrete space by \cref{lemm:duality-d-lattice-c-lattice}, $K^{\perp}/K$ is discrete. It follows that $\dim_{k}K^{\perp}/K < \infty$. Then, the fact that $\dim_{k} K$ is infinite and $K^{\perp}$ is a $K$-space yields that $K^{\perp} = K$.
\end{proof}
Now, the complement of $\widetilde{K}(D)$ for a divisor $D$ is characterized by the canonical divisor. Indeed, from the definition of $W$ it follows that for all divisors $D$
\[
	\widetilde{K}(D)^{\perp} = \widetilde{K}(W - D).
\]
\begin{lemma}\label{lemm:duality-h^0-h^1}
	For a divisor $D$
	\[
		H^{0}(\mathcal{A}(D)) \cong H^{1}(\mathcal{A}(W - D)).
	\]
\end{lemma}
\begin{proof}
	We will prove that $H^{0}(\mathcal{A}(D))^{*}\cong \widetilde{K}/H^{0}(\mathcal{A}(D))^{\perp}$. This yields the desired isomorphism, since
	\begin{align*}
		H^{0}(\mathcal{A}(D)) &= (K\cap \widetilde{K}(D))^{\perp}\\
		&= K^{\perp} + \widetilde{K}(D)^{\perp} \\
		&= K + \widetilde{K}(W - D) \quad (\text{By }\cref{lemm:K-equals-its-complement})
	\end{align*}
	Hence, $\widetilde{K}/H^{0}(\mathcal{A}(D))^{\perp} \cong H^{1}(\mathcal{A}(W - D))$. Now, the pairing restricted to $H^{0}(\mathcal{A}(D)) \times \widetilde{K}/H^{0}(\mathcal{A}(D))^{\perp}$ is perfect, therefore
	\[
		\widetilde{K}/H^{0}(\mathcal{A}(D))^{\perp} \cong H^{0}(\mathcal{A}(D))^{*}.
	\]
\end{proof}
Now, \cref{lemm:duality-h^0-h^1} yields $\dim_{k}(H^{0}(\mathcal{A}(D))) = \dim_{k}H^{1}(\mathcal{A}(W - D))$. So, for the Euler characteristic of the complex $\mathcal{A}(D)$ we obtain
\[
	\chi_{\mathcal{A}(D)} = \dim_{k}H^{0}(\mathcal{A}(D)) - \dim_{k}H^{1}(\mathcal{A}(D)) = \chi_{\mathcal{A}(W - D)}.
\]
Our next objective is to prove that
\[
	\deg D =  \chi_{\mathcal{A}(D)} - \chi_{\mathcal{A}(0)}.
\]
\begin{definition}\label{def:fredholm-map}
	A linear map between two $k$-vector spaces $f\colon V \to W$ is a \textbf{Fredholm map} if $\ker f$ and $\coker f$ are finite-dimensional. Then, the \textbf{index} of $f$ is the Euler Characteristic of the complex
	\[
		V \xrightarrow{f} W
	\]
	i.e,
	\[
		\operatorname{ind}(f) = \dim_{k}\ker f - \dim_{k}\coker f
	\]
\end{definition}
In our case, the natural maps
\[
	K\oplus \widetilde{K}(D) \to \widetilde{K}, \quad \widetilde{K}(D) \to \widetilde{K}/K, \quad K\to \widetilde{K}/\widetilde{K}(D)
\]
are all Fredholm with index equal to $\chi_{\mathcal{A}(D)}$. The following is an important property of Fredholm maps.
\begin{lemma}\label{lemm:additivity-of-index-composition}
	Let $U \xrightarrow{f} V \xrightarrow{g} W$ be Fredholm maps. Then $g \circ f$ is Fredholm and
	\[
		\operatorname{ind}(g \circ f) = \operatorname{ind}(f) + \operatorname{ind}(g).
	\]
\end{lemma}
\begin{proof}
Consider the following commutative diagram with exact rows
\[
	\begin{tikzcd}
	& 0 \ar[r] \ar[d] & U \ar[r, "1"] \ar[d, "f"] & U \ar[r] \ar[d, "g\circ f"] & 0 \\
		0 \ar[r] & \ker g \ar[r] & V \ar[r, "g"] & W & & 
	\end{tikzcd}
\]
By the Snake Lemma we get an exact sequence
\[
	0 \to \ker f \to \ker (g \circ f) \to \ker g \to \coker f \to \coker (g\circ f). 
\]
Now, consider this time the diagram
\[
	\begin{tikzcd}
	& U \ar[r, "f"] \ar[d, "g\circ f"] & V \ar[r] \ar[d, "g"] & \coker f \ar[r] \ar[d] & 0 \\
		0 \ar[r] & W \ar[r, "1"] & W \ar[r] & 0 & & 
	\end{tikzcd}
\]
and again, an application of the Snake Lemma yields an exact sequence
\[
	\ker (g \circ f) \to \ker g \to \coker f \to \coker (g \circ f) \to \coker g \to 0.
\]
Gluing these two exact sequences one gets
\begin{multline}\label{eqn:long-exact}
	0 \to \ker f \to \ker (g \circ f) \to \ker g \to \coker f  \\ \to \coker (g \circ f) \to \coker g \to 0.
\end{multline}
Then, $g \circ f$ is Fredholm. For the index, since (\ref{eqn:long-exact}) is an exact sequence of finite-dimensional vector spaces, it follows that
\begin{multline*}
	\dim_{k}\ker f - \dim_{k}\ker (g \circ f) + \dim_{k}\ker g  \\ - \dim_{k}\coker f + \dim_{k}\coker (g \circ f) - \dim_{k} \coker g = 0
\end{multline*}
which yields the desired formula.
\end{proof}	
Let $D$ be an effective divisor. Then, we have an injection $\widetilde{K}(0) \to \widetilde{K}(D)$ such that the following diagram commutes
\[
	\begin{tikzcd}
		\widetilde{K}(0) \ar[r] \ar[d] & \widetilde{K}/K \\
		\widetilde{K}(D) \ar[ur] &
	\end{tikzcd}
\]
\begin{lemma}\label{lemm:equation-effective-divisors}
	If $D$ is a divisor, then 
	\[
		\deg D =  \chi_{\mathcal{A}(D)} - \chi_{\mathcal{A}(0)}
	\]
\end{lemma}
\begin{proof}
	Suppose $D$ is effective. By \cref{lemm:additivity-of-index-composition} it follows that
	\[
		\chi_{\mathcal{A}(0)} = -\dim_{k}\coker(\widetilde{K}(0) \to \widetilde{K}(D)) + \chi_{\mathcal{A}(D)}.
	\]
	Observe that $\dim_{k}\coker(\widetilde{K}(0) \to \widetilde{K}(D)) = \deg D$. This yields the desired conclusion. The general case follows by considering $D'$ effective such that $D + D'$ is effective.
\end{proof}
From these relations it follows the well-known Riemann-Roch formula in its adèlic form.

\begin{theorem}[adèlic Riemann-Roch]\label{thm:riemann-roch-adèle}
	\[
		\dim_{k} H^{0}(\mathcal{A}(D)) = \dim_{k}H^{0}(\mathcal{A}(W - D)) + \deg D + \chi_{\mathcal{A}(0)}
	\]
\end{theorem}
\begin{proof}
	Using the two formulas
	\[
		\deg D = \chi_{\mathcal{A}(D)} - \chi_{\mathcal{A}(0)}, \quad \dim_{k}H^{0}(\mathcal{A}(D)) = \dim_{k}H^{1}(\mathcal{A}(W - D))
	\]
	we get
	\[
		\dim_{k}H^{0}(\mathcal{A}(D)) = \dim_{k}H^{0}(\mathcal{A}(W - D)) + \deg D + \chi_{\mathcal{A}(0)}. 
	\]
	In the notation of the previous section and putting $g = \dim_{k}H^{1}(\mathcal{A}(0))$
	\[
		\ell(D) = \ell(W - D) + \deg D + 1 - g.
	\]
\end{proof} 
% sheaves
%We claim that $\widetilde{K}/(\widetilde{L} + K)$ is finite dimensional. Consider the exact sequence of abelian sheaves on $X$
%\[
%	0 \rightarrow \O_{X} \rightarrow  { K } ^ { 0 } \stackrel { \delta } { \rightarrow }  { K } ^ { 1 } \rightarrow 0
%\]
%where for all $U$ open in $X$ we let $K^{0}(U) = \operatorname{Im}(K \to \widetilde{K}_{U})$ by the diagonal embedding and $K^{1}(U) = \widetilde{K}_{U}/\widetilde{L}_{U} = \bigoplus_{p\in U}K_{p}/L_{p}$. The map $\delta(U)\colon \widetilde{K}_{U} \to \widetilde{K}_{U}/\widetilde{L}_{U}$ is the natural projection.